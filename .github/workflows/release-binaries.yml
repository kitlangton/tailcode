name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write  # Required for NPM Trusted Publishers (OIDC)

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - runner: macos-latest  # arm64
            artifact: macos-arm64-binary
          - runner: macos-13      # x64 (Intel)
            artifact: macos-x64-binary
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build macOS binary
        run: |
          bun run build:bundle
          bun run build.ts compile

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/releases/*
          retention-days: 5

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build Linux binaries
        run: |
          bun run build:bundle
          bun run build.ts compile

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: dist/releases/*
          retention-days: 5

  github-release:
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/releases/
          merge-multiple: true
          pattern: '*-binary'

      - name: Generate checksums
        run: |
          cd dist/releases/
          sha256sum * > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/releases/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js for NPM publishing
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build:bundle

      - name: Publish to NPM with OIDC
        run: npm publish --access public

  update-homebrew:
    needs: github-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: kitlangton/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download release binaries and update formula
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          # Download binaries and calculate SHA256
          curl -sL "https://github.com/kitlangton/tailcode/releases/download/${VERSION}/tailcode-darwin-arm64" -o /tmp/tailcode-darwin-arm64
          curl -sL "https://github.com/kitlangton/tailcode/releases/download/${VERSION}/tailcode-darwin-x64" -o /tmp/tailcode-darwin-x64
          curl -sL "https://github.com/kitlangton/tailcode/releases/download/${VERSION}/tailcode-linux-x64" -o /tmp/tailcode-linux-x64

          SHA256_DARWIN_ARM64=$(sha256sum /tmp/tailcode-darwin-arm64 | cut -d' ' -f1)
          SHA256_DARWIN_X64=$(sha256sum /tmp/tailcode-darwin-x64 | cut -d' ' -f1)
          SHA256_LINUX_X64=$(sha256sum /tmp/tailcode-linux-x64 | cut -d' ' -f1)

          export SHA256_DARWIN_ARM64
          export SHA256_DARWIN_X64
          export SHA256_LINUX_X64

          python3 - <<'PY'
          import os
          from pathlib import Path

          version = os.environ["VERSION"]
          version_no_v = version[1:] if version.startswith("v") else version
          sha_darwin_arm64 = os.environ["SHA256_DARWIN_ARM64"]
          sha_darwin_x64 = os.environ["SHA256_DARWIN_X64"]
          sha_linux_x64 = os.environ["SHA256_LINUX_X64"]

          formula = f'''class Tailcode < Formula
            desc "Terminal wizard for publishing OpenCode to your Tailscale tailnet"
            homepage "https://github.com/kitlangton/tailcode"
            version "{version_no_v}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/kitlangton/tailcode/releases/download/{version}/tailcode-darwin-arm64"
                sha256 "{sha_darwin_arm64}"
              else
                url "https://github.com/kitlangton/tailcode/releases/download/{version}/tailcode-darwin-x64"
                sha256 "{sha_darwin_x64}"
              end
            end

            on_linux do
              if Hardware::CPU.intel?
                url "https://github.com/kitlangton/tailcode/releases/download/{version}/tailcode-linux-x64"
                sha256 "{sha_linux_x64}"
              end
            end

            def install
              bin.install Dir["tailcode*"].first => "tailcode"
            end

            test do
              system "#{{bin}}/tailcode", "--help"
            end
          end
          '''

          Path("homebrew-tap/Formula/tailcode.rb").write_text(formula)
          PY

      - name: Commit and push formula update
        run: |
          cd homebrew-tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/tailcode.rb
          if git diff --cached --quiet; then
            echo "No Homebrew formula changes to commit"
            exit 0
          fi
          git commit -m "Update tailcode to ${{ github.ref_name }}"
          git push

  verify:
    needs: [github-release, publish-npm, update-homebrew]
    runs-on: ubuntu-latest
    steps:
      - name: Verify GitHub Release assets
        env:
          VERSION: ${{ github.ref_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking GitHub release assets for $VERSION..."
          ASSETS=$(gh release view "$VERSION" --repo kitlangton/tailcode --json assets -q '[.assets[].name] | join(" ")')
          FAILED=0
          for name in tailcode-darwin-arm64 tailcode-darwin-x64 tailcode-linux-x64 SHA256SUMS; do
            if echo "$ASSETS" | grep -q "$name"; then
              echo "✅ $name"
            else
              echo "❌ Missing: $name"
              FAILED=1
            fi
          done
          [ "$FAILED" -eq 0 ] || exit 1

      - name: Verify npm package
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION_NO_V="${VERSION#v}"
          echo "Checking npm for @kitlangton/tailcode@$VERSION_NO_V..."
          for i in $(seq 1 12); do
            PUBLISHED=$(npm view @kitlangton/tailcode version 2>/dev/null || true)
            if [ "$PUBLISHED" = "$VERSION_NO_V" ]; then
              echo "✅ npm: @kitlangton/tailcode@$VERSION_NO_V"
              break
            fi
            echo "⏳ ($i/12) npm shows '$PUBLISHED', retrying in 10s..."
            sleep 10
          done
          if [ "$PUBLISHED" != "$VERSION_NO_V" ]; then
            echo "❌ npm not updated: expected $VERSION_NO_V, got $PUBLISHED"
            exit 1
          fi

      - name: Verify Homebrew formula
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION_NO_V="${VERSION#v}"
          echo "Checking Homebrew formula for $VERSION_NO_V..."
          for i in $(seq 1 12); do
            FORMULA=$(curl -sf "https://raw.githubusercontent.com/kitlangton/homebrew-tap/main/Formula/tailcode.rb" || true)
            if echo "$FORMULA" | grep -q "version \"$VERSION_NO_V\""; then
              echo "✅ Homebrew formula updated to $VERSION_NO_V"
              break
            fi
            echo "⏳ ($i/12) formula not updated yet, retrying in 10s..."
            sleep 10
          done
          if ! echo "$FORMULA" | grep -q "version \"$VERSION_NO_V\""; then
            echo "❌ Homebrew formula not updated to $VERSION_NO_V"
            exit 1
          fi
